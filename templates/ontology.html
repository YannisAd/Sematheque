{% extends "layout.html" %}
{% block title %}Parcours Ontologie{% endblock %}

{% block content %}
<style>
    /** Styles spécifiques à la visualisation de l'ontologie (Graphe D3.js). */

    .ontology-container {
        display: flex;
        height: calc(100vh - 180px);
        margin-top: 20px;
        width: 100%;
    }

    .graph-container {
        flex: 4;
        height: 100%;
        min-width: 70%;
        border: 1px solid #ddd;
        border-radius: 5px;
        position: relative;
        background: #fff;
    }

    .sidebar {
        flex: 1.5;
        min-width: 25%;
        height: 100%;
        border: 1px solid #ddd;
        border-radius: 5px;
        margin-left: 20px;
        padding: 15px;
        overflow-y: auto;
        background: #f8f9fa;
    }

    .controls {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 100;
        background: rgba(255, 255, 255, 0.95);
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        max-width: 280px;
    }

    .legend {
        position: absolute;
        bottom: 20px;
        right: 20px;
        z-index: 100;
        background: rgba(255, 255, 255, 0.95);
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        max-width: 250px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }

    .legend-color {
        width: 20px;
        height: 20px;
        margin-right: 8px;
        border-radius: 3px;
    }

    .legend-line {
        width: 30px;
        height: 3px;
        margin-right: 8px;
    }

    .node {
        cursor: pointer;
    }

    .node circle {
        fill: #fff;
        stroke: steelblue;
        stroke-width: 3px;
    }

    .node text {
        font: 12px sans-serif;
        pointer-events: none;
    }

    .link {
        fill: none;
        stroke: #ccc;
        stroke-width: 2px;
    }

    .tooltip {
        position: absolute;
        background: white;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s;
        z-index: 1000;
    }

    .resource-link {
        color: #0d6efd;
        cursor: pointer;
        text-decoration: none;
    }

    .resource-link:hover {
        text-decoration: underline;
    }

    .sidebar-title {
        margin-top: 0;
        padding-bottom: 10px;
        border-bottom: 1px solid #ddd;
    }

    .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
        width: 100%;
        position: absolute;
        top: 0;
        left: 0;
        background-color: rgba(255, 255, 255, 0.8);
        z-index: 1000;
    }

    .loader {
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .search-container {
        margin-bottom: 15px;
        position: relative;
    }

    .search-results {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #eee;
        border-radius: 4px;
        display: none;
        background: white;
        z-index: 1100;
        position: absolute;
        width: 100%;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .highlighted-node path {
        stroke-width: 5px !important;
        filter: drop-shadow(0 0 5px rgba(0, 0, 0, 0.3));
    }

    .highlighted-text {
        font-weight: bold !important;
    }

    .view-controls {
        margin-top: 15px;
        border-top: 1px solid #ddd;
        padding-top: 15px;
    }
</style>

<div class="container-fluid mt-3">
    <p class="lead">Explorez la structure de l'ontologie et les instances associées</p>

    <div class="ontology-container">
        <div class="graph-container" id="graph">
            <div class="controls">
                <div class="btn-group w-100 mb-2">
                    <button id="zoomIn" class="btn btn-sm btn-outline-primary"><i
                            class="fas fa-search-plus"></i></button>
                    <button id="zoomOut" class="btn btn-sm btn-outline-primary"><i
                            class="fas fa-search-minus"></i></button>
                    <button id="resetView" class="btn btn-sm btn-outline-secondary"><i class="fas fa-redo"></i></button>
                </div>

                <div class="view-controls text-center">
                    <button id="showSimplifiedView" class="btn btn-sm btn-outline-success w-100" style="display: none;">
                        <i class="fas fa-eye-slash me-1"></i> Vue simplifiée
                    </button>
                    <button id="showAllElements" class="btn btn-sm btn-outline-primary w-100">
                        <i class="fas fa-eye me-1"></i> Afficher tout
                    </button>
                </div>

                <div class="search-container mt-3">
                    <input type="text" id="searchInput" placeholder="Rechercher une classe..."
                        class="form-control form-control-sm">
                    <div id="searchResults" class="search-results"></div>
                </div>
            </div>

            <div class="legend" id="graphLegend"></div>

            <div id="loading" class="loading">
                <div class="loader"></div>
            </div>
        </div>

        <div class="sidebar" id="sidebar">
            <h5 class="sidebar-title">Détails</h5>
            <div id="detailsContent">
                <p class="text-muted small">Sélectionnez une classe ou une instance pour afficher ses détails.</p>
            </div>
        </div>
    </div>
</div>

<script src="https://d3js.org/d3.v7.min.js"></script>

<script>
    const ontologyData = {{ ontology_data| safe }};

    let svg, g, zoom;
    let width, height;
    let simulation;
    let nodes = [], links = [];
    let tooltip;
    let currentFocus = null;
    let importantClasses = new Set();
    let importantProperties = new Set();
    let simplifiedViewActive = true;

    const filters = {
        classes: true,
        properties: true,
        subClassLinks: true,
        domainLinks: true,
        rangeLinks: true
    };

    /** Initialise la visualisation D3.js, le zoom et les écouteurs. */
    function initGraph() {
        const container = document.getElementById('graph');
        width = container.clientWidth;
        height = container.clientHeight;

        zoom = d3.zoom()
            .scaleExtent([0.1, 4])
            .on("zoom", (event) => g.attr("transform", event.transform));

        svg = d3.select("#graph").append("svg")
            .attr("width", width)
            .attr("height", height)
            .call(zoom);

        g = svg.append("g");

        tooltip = d3.select("#graph").append("div")
            .attr("class", "tooltip");

        document.getElementById("zoomIn").addEventListener("click", () => svg.transition().call(zoom.scaleBy, 1.3));
        document.getElementById("zoomOut").addEventListener("click", () => svg.transition().call(zoom.scaleBy, 0.7));
        document.getElementById("resetView").addEventListener("click", () => svg.transition().call(zoom.transform, d3.zoomIdentity.scale(0.5).translate(width / 4, height / 4)));

        document.getElementById("showAllElements").addEventListener("click", showAllElements);
        document.getElementById("showSimplifiedView").addEventListener("click", showSimplifiedView);
        document.getElementById("searchInput").addEventListener("input", handleSearch);

        if (!ontologyData.classes || ontologyData.classes.length === 0) {
            loadOntologyFromAPI();
        } else {
            buildGraph(ontologyData);
        }
    }

    /** Récupère les données de structure via l'API si elles ne sont pas préchargées. */
    function loadOntologyFromAPI() {
        fetch('/api/ontology/structure')
            .then(response => response.json())
            .then(data => {
                if (data.classes && data.classes.length > 0) {
                    buildGraph(data);
                } else {
                    showError("Structure de l'ontologie vide.");
                }
            })
            .catch(error => showError("Erreur chargement: " + error.message));
    }

    /** Affiche un message d'erreur dans le conteneur SVG. */
    function showError(message) {
        document.getElementById("loading").style.display = "none";
        g.append("text")
            .attr("x", width / 2)
            .attr("y", height / 2)
            .attr("text-anchor", "middle")
            .attr("fill", "red")
            .text(message);
    }

    /** Construit les nœuds, liens et la simulation physique D3. */
    function buildGraph(data) {
        if (!data.classes || data.classes.length === 0) {
            showError("Aucune donnée disponible");
            return;
        }

        importantClasses.clear();
        importantProperties.clear();

        data.classes.forEach(c => {
            if ((c.superClasses && c.superClasses.length > 0) || (c.properties && c.properties.length > 0)) {
                importantClasses.add(c.uri);
            }
        });

        if (data.relations) {
            data.relations.forEach(r => {
                if (r.domains && r.domains.length > 0 && r.ranges && r.ranges.length > 0) {
                    importantProperties.add(r.uri);
                }
            });
        }

        nodes = data.classes.map(c => ({
            id: c.uri,
            label: c.label || c.uri.split('#').pop(),
            type: 'class',
            superClasses: c.superClasses || [],
            properties: c.properties || [],
            color: "#4CAF50",
            isImportant: importantClasses.has(c.uri)
        }));

        if (data.relations) {
            data.relations.forEach(r => {
                if (!nodes.some(n => n.id === r.uri)) {
                    const hasDomains = r.domains && r.domains.length > 0;
                    const hasRanges = r.ranges && r.ranges.length > 0;
                    let color = "#9E9E9E";

                    if (hasDomains && hasRanges) color = "#FF9800";
                    else if (hasDomains) color = "#E91E63";
                    else if (hasRanges) color = "#2196F3";

                    nodes.push({
                        id: r.uri,
                        label: r.label || r.uri.split('#').pop(),
                        type: 'property',
                        domains: r.domains || [],
                        ranges: r.ranges || [],
                        color: color,
                        isImportant: importantProperties.has(r.uri)
                    });
                }
            });
        }

        links = [];
        data.classes.forEach(c => {
            if (c.superClasses) {
                c.superClasses.forEach(sc => links.push({
                    source: c.uri, target: sc.uri, type: 'subClassOf', label: 'sous-classe'
                }));
            }
        });

        if (data.relations) {
            data.relations.forEach(r => {
                if (r.domains) r.domains.forEach(d => links.push({ source: r.uri, target: d.uri, type: 'domain', label: '' }));
                if (r.ranges) r.ranges.forEach(rng => links.push({ source: r.uri, target: rng.uri, type: 'range', label: '' }));
            });
        }

        simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d => d.id).distance(200))
            .force("charge", d3.forceManyBody().strength(d => d.type === 'class' ? -1500 : -800))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("collide", d3.forceCollide().radius(80));

        const link = g.append("g").attr("class", "links").selectAll("g").data(links).enter().append("g");

        const path = link.append("path")
            .attr("class", "link")
            .attr("stroke", d => {
                if (d.type === 'subClassOf') return "#555";
                if (d.type === 'domain') return "#E91E63";
                if (d.type === 'range') return "#2196F3";
                return "#ccc";
            })
            .attr("stroke-dasharray", d => d.type === 'domain' || d.type === 'range' ? "5,5" : "none")
            .attr("marker-end", "url(#arrowhead)");

        svg.append("defs").append("marker")
            .attr("id", "arrowhead")
            .attr("viewBox", "0 -5 10 10")
            .attr("refX", 25).attr("refY", 0)
            .attr("markerWidth", 6).attr("markerHeight", 6)
            .attr("orient", "auto")
            .append("path")
            .attr("d", "M0,-5L10,0L0,5")
            .attr("fill", "#999");

        const node = g.append("g").attr("class", "nodes").selectAll(".node")
            .data(nodes).enter().append("g")
            .attr("class", "node")
            .call(d3.drag()
                .on("start", dragStarted).on("drag", dragged).on("end", dragEnded))
            .on("click", showDetails)
            .on("mouseover", showTooltip)
            .on("mouseout", hideTooltip);

        node.append("path")
            .attr("d", d => d.type === 'property' ? hexagonPath(20) : d3.arc()({ innerRadius: 0, outerRadius: 20, startAngle: 0, endAngle: 2 * Math.PI }))
            .attr("fill", d => d.type === 'class' ? "#e8f5e9" : "#fff")
            .attr("stroke", d => d.color)
            .attr("stroke-width", d => d.type === 'class' ? 3 : 2);

        node.append("text")
            .attr("dy", 35)
            .attr("text-anchor", "middle")
            .text(d => d.label)
            .style("font-weight", d => d.type === 'class' ? "bold" : "normal");

        simulation.on("tick", () => {
            path.attr("d", d => {
                const dx = d.target.x - d.source.x, dy = d.target.y - d.source.y;
                const dr = Math.sqrt(dx * dx + dy * dy);
                const offX = dx * 20 / dr, offY = dy * 20 / dr;
                return `M${d.source.x},${d.source.y}L${d.target.x - offX},${d.target.y - offY}`;
            });
            node.attr("transform", d => `translate(${d.x},${d.y})`);
        });

        createLegend();
        document.getElementById("loading").style.display = "none";
        showSimplifiedView();
        setTimeout(() => svg.call(zoom.transform, d3.zoomIdentity.scale(0.6).translate(width / 3, height / 3)), 100);
    }

    /** Génère la légende explicative du graphe. */
    function createLegend() {
        const legend = d3.select("#graphLegend");
        legend.html("");
        const items = [
            { color: "#4CAF50", label: "Classe", type: "rect" },
            { color: "#FF9800", label: "Propriété Objet", type: "hex" },
            { color: "#E91E63", label: "Propriété Donnée", type: "hex" },
            { color: "#555", label: "Sous-classe", type: "line" }
        ];

        items.forEach(item => {
            const div = legend.append("div").attr("class", "legend-item");
            if (item.type === "rect") div.append("div").attr("class", "legend-color").style("background", item.color);
            else if (item.type === "line") div.append("div").attr("class", "legend-line").style("background", item.color);
            else div.append("span").style("color", item.color).style("margin-right", "8px").text("⬡");
            div.append("span").text(item.label);
        });
    }

    /** Calcule le chemin SVG pour dessiner un hexagone. */
    function hexagonPath(size) {
        const points = [];
        for (let i = 0; i < 6; i++) {
            const angle = (i * Math.PI) / 3;
            points.push([size * Math.cos(angle), size * Math.sin(angle)]);
        }
        return `M${points[0][0]},${points[0][1]}L${points[1][0]},${points[1][1]}L${points[2][0]},${points[2][1]}L${points[3][0]},${points[3][1]}L${points[4][0]},${points[4][1]}L${points[5][0]},${points[5][1]}Z`;
    }

    /** Gestionnaire de clic sur un nœud pour afficher ses détails. */
    function showDetails(event, d) {
        currentFocus = d;
        d3.selectAll(".node path").attr("stroke-width", n => n.id === d.id ? 5 : (n.type === 'class' ? 3 : 2));

        if (d.type === 'class') showClassDetails(d);
        else if (d.type === 'property') showPropertyDetails(d.id);
    }

    /** Affiche les détails d'une classe dans la sidebar. */
    function showClassDetails(node) {
        const container = document.getElementById('detailsContent');
        let html = `
            <div class="card mb-3 border-success">
                <div class="card-header bg-success text-white">${node.label}</div>
                <div class="card-body py-2"><small class="text-muted text-break">${node.id}</small></div>
            </div>`;

        if (node.superClasses && node.superClasses.length > 0) {
            html += `<h6 class="mt-3">Superclasses</h6><ul class="list-group list-group-flush small">`;
            node.superClasses.forEach(sc => {
                html += `<li class="list-group-item px-0"><a href="#" class="resource-link" onclick="navigateToClass('${sc.uri}')">${sc.label}</a></li>`;
            });
            html += `</ul>`;
        }

        if (node.properties && node.properties.length > 0) {
            html += `<h6 class="mt-3">Propriétés</h6><ul class="list-group list-group-flush small">`;
            node.properties.forEach(p => {
                html += `<li class="list-group-item px-0"><i class="fas fa-circle text-warning me-1" style="font-size:6px"></i>${p.label}</li>`;
            });
            html += `</ul>`;
        }

        container.innerHTML = html;
    }

    /** Affiche les détails d'une propriété dans la sidebar. */
    function showPropertyDetails(uri) {
        const node = nodes.find(n => n.id === uri);
        if (!node) return;

        const container = document.getElementById('detailsContent');
        let html = `
            <div class="card mb-3 border-warning">
                <div class="card-header bg-warning text-dark">${node.label}</div>
                <div class="card-body py-2"><small class="text-muted text-break">${node.id}</small></div>
            </div>`;

        if (node.domains && node.domains.length) {
            html += `<h6>Domaines</h6><ul class="list-group list-group-flush small">`;
            node.domains.forEach(d => html += `<li class="list-group-item px-0"><a href="#" class="resource-link" onclick="navigateToClass('${d.uri}')">${d.label}</a></li>`);
            html += `</ul>`;
        }
        if (node.ranges && node.ranges.length) {
            html += `<h6>Ranges</h6><ul class="list-group list-group-flush small">`;
            node.ranges.forEach(r => html += `<li class="list-group-item px-0"><a href="#" class="resource-link" onclick="navigateToClass('${r.uri}')">${r.label}</a></li>`);
            html += `</ul>`;
        }
        container.innerHTML = html;
    }

    /** Charge et affiche les détails d'une instance spécifique. */
    function loadInstanceDetails(uri) {
        const container = document.getElementById('detailsContent');
        container.innerHTML = `<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div></div>`;

        fetch(`/api/resource_details?uri=${encodeURIComponent(uri)}`)
            .then(res => res.json())
            .then(data => {
                if (data.success && data.details) {
                    showInstanceDetailsGeneric(data.details, uri);
                } else {
                    container.innerHTML = `<div class="alert alert-warning">Impossible de charger les détails.</div>`;
                }
            })
            .catch(err => container.innerHTML = `<div class="alert alert-danger">${err}</div>`);
    }

    /** Formate et affiche les détails génériques reçus de l'API. */
    function showInstanceDetailsGeneric(details, uri) {
        const labelRow = details.find(d => d.Property === 'http://www.w3.org/2000/01/rdf-schema#label');
        const typeRow = details.find(d => d.Property === 'http://www.w3.org/1999/02/22-rdf-syntax-ns#type');

        const label = labelRow ? labelRow.Value : 'Instance';
        const typeLabel = typeRow ? (typeRow.ValueLabel || typeRow.Value) : 'Inconnu';

        let html = `
            <div class="card mb-3 border-info">
                <div class="card-header bg-info text-white">${label}</div>
                <div class="card-body">
                    <span class="badge bg-secondary mb-2">${typeLabel}</span>
                    <p class="small text-muted text-break mb-0">${uri}</p>
                </div>
            </div>
            <h6 class="mt-3">Propriétés</h6>
            <ul class="list-group list-group-flush small">
        `;

        const grouped = {};
        details.forEach(row => {
            if (row.Property === 'http://www.w3.org/2000/01/rdf-schema#label' ||
                row.Property === 'http://www.w3.org/1999/02/22-rdf-syntax-ns#type') return;

            if (!grouped[row.PropertyLabel]) grouped[row.PropertyLabel] = [];
            grouped[row.PropertyLabel].push(row);
        });

        for (const [propName, vals] of Object.entries(grouped)) {
            html += `<li class="list-group-item px-0">
                <strong>${propName}:</strong><br>`;
            vals.forEach(v => {
                const valShow = v.ValueLabel || v.Value;
                if (v.Value.startsWith('http')) {
                    html += `<a href="#" class="resource-link d-block ms-2" onclick="loadInstanceDetails('${v.Value}')">${valShow}</a>`;
                } else {
                    html += `<span class="d-block ms-2 text-muted">${valShow}</span>`;
                }
            });
            html += `</li>`;
        }

        html += `</ul>`;
        document.getElementById('detailsContent').innerHTML = html;
    }

    /** Centre le graphe sur un nœud spécifique ou charge ses détails. */
    function navigateToClass(uri) {
        const node = nodes.find(n => n.id === uri);
        if (node) {
            if (simplifiedViewActive && !node.isImportant) showAllElements();
            const transform = d3.zoomIdentity.translate(width / 2, height / 2).scale(1).translate(-node.x, -node.y);
            svg.transition().duration(750).call(zoom.transform, transform);
            showDetails(null, node);
        } else {
            loadInstanceDetails(uri);
        }
    }

    /** Filtre les nœuds affichés dans la liste de recherche. */
    function handleSearch() {
        const q = this.value.toLowerCase();
        const resBox = document.getElementById('searchResults');
        if (q.length < 2) { resBox.style.display = 'none'; return; }

        const matches = nodes.filter(n => n.label.toLowerCase().includes(q)).slice(0, 10);
        if (matches.length > 0) {
            resBox.innerHTML = matches.map(n =>
                `<div class="p-2 border-bottom" style="cursor:pointer" onclick="navigateToClass('${n.id}'); document.getElementById('searchResults').style.display='none'">
                    <i class="fas ${n.type === 'class' ? 'fa-cube text-success' : 'fa-link text-warning'} me-2"></i>${n.label}
                </div>`
            ).join('');
            resBox.style.display = 'block';
        } else {
            resBox.style.display = 'none';
        }
    }

    /** Active la vue complète affichant tous les nœuds. */
    function showAllElements() {
        simplifiedViewActive = false;
        d3.selectAll('.node, .link').style('display', null);
        document.getElementById('showAllElements').style.display = 'none';
        document.getElementById('showSimplifiedView').style.display = 'inline-block';
    }

    /** Active la vue simplifiée (classes principales seulement). */
    function showSimplifiedView() {
        simplifiedViewActive = true;
        d3.selectAll('.node').style('display', d => (d.type === 'class' && !importantClasses.has(d.id)) || (d.type === 'property' && !importantProperties.has(d.id)) ? 'none' : null);
        d3.selectAll('.link').style('display', d => {
            const srcImp = importantClasses.has(d.source.id) || importantProperties.has(d.source.id);
            const tgtImp = importantClasses.has(d.target.id) || importantProperties.has(d.target.id);
            return (!srcImp || !tgtImp) ? 'none' : null;
        });
        document.getElementById('showSimplifiedView').style.display = 'none';
        document.getElementById('showAllElements').style.display = 'inline-block';
    }

    function dragStarted(event, d) { if (!event.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; }
    function dragged(event, d) { d.fx = event.x; d.fy = event.y; }
    function dragEnded(event, d) { if (!event.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; }
    function showTooltip(event, d) {
        tooltip.transition().style("opacity", .9);
        tooltip.html(`<strong>${d.label}</strong><br><small>${d.type}</small>`)
            .style("left", (event.pageX + 10) + "px").style("top", (event.pageY - 28) + "px");
    }
    function hideTooltip() { tooltip.transition().style("opacity", 0); }

    document.addEventListener('DOMContentLoaded', initGraph);
</script>
{% endblock %}